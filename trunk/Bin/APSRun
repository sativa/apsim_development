#! /usr/bin/tclsh

#APSRun - run apsim
# Converts .con files to .sim files and runs them

set BINDIR [file dirname [info script]]
set APSROOT [file dirname $BINDIR]
set env(LD_LIBRARY_PATH) $APSROOT/lib

proc run {arg} {
   if {[string tolower [file extension $arg]] == ".run"} {
	doRunFile $arg
    } elseif {[string tolower [file extension $arg]] == ".con"} {
	doConFile $arg
    } elseif {[string tolower [file extension $arg]] == ".sim"} {
	doSimFile $arg
    } else {
	puts stderr "Don't know what to do with $arg"
    }
}

proc doRunFile {arg} {
    global APSROOT
    set fp [open $arg r]
    while {[gets $fp line] >= 0} {
	if {[llength [set z [split $line "="]]] == 2} {
	    regsub  {%apsuite} [lindex $z 1] $APSROOT file
	    run $file
	}
    } 
    close $fp
}

proc doConFile {arg} {
    global BINDIR
    catch {
	puts "Simifying $arg"
	cd [file dirname $arg]
	set t0 [expr [clock seconds] - 1]
	runCmd  "$BINDIR/ConToSim.x \"$arg\""
	foreach simfile [glob -nocomplain *.sim] {
	    if {[file mtime $simfile] >= $t0} {
		    doSimFile $simfile
	    }
	}
    } msg
    if {$msg != ""} {puts stderr $msg}
}

proc doSimFile {arg} {
    global BINDIR
    catch {
        puts "Running $arg"
        cd [file dirname $arg]
        set sumfile "[file root $arg].sum"
        runCmd  "$BINDIR/apsim.x \"$arg\" >& \"$sumfile\""
    } msg
    if {$msg != ""} {puts stderr $msg}
}

proc runCmd {cmd} {
    catch {
	eval exec $cmd
    } msg
    if {$msg != ""} {puts stderr "\nError running '$cmd' in wd=[pwd].\n$msg\n"}
}

foreach arg $argv {
   run $arg
}

